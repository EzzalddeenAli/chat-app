<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      body {
        background-color: rgba(255, 255, 255, 1);
        font-size: 14px;
        font-family: Helvetica, Arial;
        transition: background-color .25s linear;
      }

      body.online {
        background-color: rgba(255, 255, 255, 1);
      }

      body.offline {
        background-color: rgba(0, 0, 0, .2);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      form {
        background: #000;
        padding: 3px;
        position: fixed;
        bottom: 0;
        width: 100%;
      }

      form input {
        border: 0;
        padding: 10px;
        width: 90%;
        margin-right: .5%;
      }

      form button {
        width: 9%;
        background: rgb(130, 224, 255);
        border: none;
        padding: 10px;
      }

      #messages {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      #messages li {
        padding: 5px 10px;
        display: block;
        min-height: 45px;
      }

      .msg-area {
        float: left;
      }

      .date {
        float: right;
        margin-top: 10px;
      }

      .message {
        clear: both;
        display: block;
      }

      #messages li:nth-child(odd) {
        background: #eee;
      }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>

    <form>
      <input id="user" type="text" placeholder="Nome">
      <br>
      <input id="msg" type="text" placeholder="Mensagem">
      <button>Send</button>
    </form>

    <!-- Libs -->
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.3.2/firebase.js"></script>


    <!-- Custom -->
    <script>
      var socket, chat_log, system_log, config;

      socket = io();

      // ====
      $('form').submit(function(){
        var obj;

        obj = {
          'user': $('#user').val(),
          'msg': $('#msg').val(),
          'timestamp': new Date().getTime()
        };

        socket.emit('chat message', obj);

        $('#user').val('');
        $('#msg').val('');

        return false;
      });
      // ====

      //
      // Socket
      //

      socket.on('guest_connected', function(obj) {
        _buildLog(obj);
        SetDataIntoDB(system_log, obj);
      });

      socket.on('guest_disconnect', function(obj) {
        _buildLog(obj);
        SetDataIntoDB(system_log, obj);
      });

      socket.on('new_user', function(obj) {
        _buildLog(obj);
        SetDataIntoDB(system_log, obj);
      });

      socket.on('chat_message', function(obj){
        _buildLog(obj);
        SetDataIntoDB(chat_log, obj);
      });

      function _buildLog(obj) {
        console.log(obj);

       var li, div, h4, p, date;

        li = $('<li>');
        div = $('<div class="msg-area">');

        h4 = $('<h4 class="user">').text(obj.user);
        p = $('<p class="message">').text(obj.msg);
        date = $('<span class="date">').text(obj.timestamp);

        (li).append(div);
        (li).append(date);

        (div).append(h4);
        (div).append(p);

        $('#messages').append(li);
      }
      // ====

      //
      // Firebase
      //

      InitFirebase();

      function InitFirebase() {
        config = {
          apiKey: "AIzaSyBUPtWSIjrJZaN8O-4SLgj928-FNnjXxWc",
          authDomain: "realtime-chatapp.firebaseapp.com",
          databaseURL: "https://realtime-chatapp.firebaseio.com",
          storageBucket: "realtime-chatapp.appspot.com",
        };

        firebase.initializeApp(config);

        // ====

        chat_log = SetDatabase('chat_log');
        system_log = SetDatabase('system_log');

        // ====

        chat_log.on('value', function(snapshot) {
          console.info('chat_log');
          console.warn(snapshot.val());
        });

        system_log.on('value', function(snapshot) {
          console.info('system_log');
          console.warn(snapshot.val());
        });
      }

      function SetDatabase(db) {
        return firebase.database().ref(db);
      }

      function SetDataIntoDB(db, obj) {
        db.push(obj).then(function(result) {
          console.info(result);
          return result;
        }, function(err) {
          console.error(err);
          return err;
        });
      }
      // ====


      //
      // Offline
      //

      var network, status;

      network = true;

      function ChangeNetwork() {
        status = navigator.onLine ? "online" : "offline";

        document.getElementsByTagName('body')[0].setAttribute('class', '');
        document.getElementsByTagName('body')[0].classList.add(status)
      }

      window.addEventListener('online', ChangeNetwork);
      window.addEventListener('offline', ChangeNetwork);
      // ====
    </script>
  </body>
</html>
